# ------------------------------------------------------------------------------
# Set base16 color.  Mom and Dad a simple tribute to my parents.
# ------------------------------------------------------------------------------
function mom() {
  base16Color $1 dark
}
function dad() {
  base16Color $1 light
}
function ct() {
  cd ~/git/color/base16-shell && ./colortest && cd -
}
function base16Color() {
  source ~/git/color/base16-shell/scripts/base16-$1-$2.sh
  echo "Base16 color: " $1 $2
}

# ------------------------------------------------------------------------------
# A few helper aliases.
# ------------------------------------------------------------------------------
alias tmux='tmux -2'
export TERM=xterm-256color
alias lad='ls -lad .*'

# ------------------------------------------------------------------------------
# Operating system specific settings.
# ------------------------------------------------------------------------------
echo "Operating system: " ${OSTYPE}
if [[ ${OSTYPE} =~ "darwin" ]]; then
    export CLICOLOR=1
    export LSCOLORS=GxFxBxDxCxegedabagacad
    export PATH="${HOME}/Library/Haskell/bin:${PATH}"
    alias me='clear && source ~/.bash_profile'
    alias la='ls -A'
    alias ll='ls -lahG'
    if [[ ${HOSTNAME} =~ "Stooges" ]]; then
      alias  fpc0='sshfs fpc:git/smart-device-sw /Volumes/Larry/fpc0'
      alias ufpc0='umount /Volumes/Larry/fpc0'
      alias   ds6='sshfs datasci:git/smart-device-sw /Volumes/Larry/ds6'
      alias  uds6='umount /Volumes/Larry/ds6'
    else
      alias  fpc0='sshfs fpc:git/smart-device-sw ~/fpc0'
      alias ufpc0='umount ~/fpc0'
      alias   ds6='sshfs datasci:git/smart-device-sw ~/ds6'
      alias  uds6='umount ~/ds6'
    fi
    if [[ -f $(brew --prefix)/etc/bash_completion ]]; then
      . $(brew --prefix)/etc/bash_completion
    fi
elif [[ ${OSTYPE} =~ "linux" ]] \
  || [[ ${OSTYPE} =~ "cygwin" ]] \
  || [[ ${OSTYPE} =~ "msys" ]] ; then
    if [[ ${OSTYPE} =~ "linux" ]]; then
      export PATH="${HOME}/.cabal/bin:/home/linuxbrew/.linuxbrew/bin:${PATH}"
    elif [[ ${OSTYPE} =~ "cygwin" ]]; then
      export PATH="~/bin:${PATH}"
      alias ra='cygstart --open'
      export HOMEDRIVE="C:"
      export HOMESHARE=${HOME}
    elif [[ ${OSTYPE} =~ "msys" ]]; then
      export PATH="~/.gem/ruby/2.3.0/bin:${PATH}"
    fi
    alias me='clear && source ~/.bashrc'
    alias la='ls -A --color'
    alias ls='ls --color=auto'
    alias ll='ls -lahG --color'
    d=.dircolors
    test -r $d && eval "$(dircolors $d)"
    if [[ -f /usr/share/bash-completion/bash_completion ]]; then
      . /usr/share/bash-completion/bash_completion
    fi
else
    echo "Unknown operating system:" ${OSTYPE}
fi

# ------------------------------------------------------------------------------
# iTerm2 shell integration.
# ------------------------------------------------------------------------------
if [[ -f ${HOME}/.iterm2_shell_integration.bash ]]; then
  source ${HOME}/.iterm2_shell_integration.bash
fi

# ------------------------------------------------------------------------------
# Travis integration
# ------------------------------------------------------------------------------
if [[ -f ${HOME}.travis/travis.sh ]]; then
  source ${HOME}.travis/travis.sh
fi

# ------------------------------------------------------------------------------
# Stack specific settings.
# ------------------------------------------------------------------------------
if [[ -s /usr/local/bin/stack ]]; then
  eval "$(stack --bash-completion-script stack)"
fi

# ------------------------------------------------------------------------------
# HMST project specific settings.
# ------------------------------------------------------------------------------
export HMST_BIN="${HOME}/git/smart-device-sw/tools/bin"
alias cc='python3 ${HMST_BIN}/clean-code'
alias pdfmake='${HMST_BIN}/pdfmake'

# ------------------------------------------------------------------------------
# Use vim or emacs keybindings.  Troubleshoot tmux + vim + vim-keybindings.
# ------------------------------------------------------------------------------
set -o emacs

# ------------------------------------------------------------------------------
# Haskell and Cabal
# ------------------------------------------------------------------------------
alias ci='cabal install'
alias cif='cabal install --force-reinstalls'
alias cemacs='emacs -Q -l ~/git/emacs-haskell-config/init.el'
alias cls='clear'

# ------------------------------------------------------------------------------
# General purpose aliases.
# ------------------------------------------------------------------------------
alias decrypt='~/git/dotfiles/decrypt'
alias ec='emacsclient -c'
alias egrep='egrep --color=auto'
alias encrypt='~/git/dotfiles/encrypt'
alias fgrep='fgrep --color=auto'
alias grep='grep --color=auto'
alias h='history'
alias ssh='ssh -A'

# ------------------------------------------------------------------------------
# Aliases to folders within my Git root.
# ------------------------------------------------------------------------------
alias ac='cd ~/git/AllanConsulting'
alias bootd='cd ~/git/bootstrap'
alias color='cd ~/git/color'
alias dot='cd ~/git/dotfiles/'
alias fk='cd ~/git/fk/'
alias hh='cd ~/git/HowardHouse'
alias resume='cd ~/git/resume'
alias sshd='cd ~/git/ssh'
alias tmuxd='cd ~/git/tmux'
alias vimd='cd ~/git/vim'

# ------------------------------------------------------------------------------
# A function to grep my command history
# ------------------------------------------------------------------------------
function hg() {
  history | grep "$1"
}

# ------------------------------------------------------------------------------
# File & String related functions
# ------------------------------------------------------------------------------
function ff()  {
  find . -type f -iname "$1" -print ;
}
function ffr() { find . -name "$1" -delete -ls ; }
function ffw() {
  local ext=$1 pattern=$2
  find . -name "$ext" -type f -exec grep "$pattern" /dev/null {} +
}

# ------------------------------------------------------------------------------k
# Use functions to create pdf document.
# ------------------------------------------------------------------------------k
function adoc() {
  f=$(basename "$1")
  f="${f%.*}"
  time asciidoctor \
         --trace \
         --require asciidoctor-pdf \
         --backend pdf \
         --attribute pdf-style=$HOME/git/dotfiles/asciidoctor/basic-theme.yml \
         --out-file _build/"$f".pdf \
         "$1" ;
}
function a2l() {
  time \
    asciidoctor-latex \
         --no-header-footer \
         --safe-mode=secure \
         "$1" ;
}
function atex() {
  mkdir -p _pdf
#  time \
    pdflatex \
         --no-shell-escape \
         --interaction=batchmode \
         --output-directory _build \
         "$1" ;
}

# ----------------------------------------------------------------------------t-
# Git helpers
# ------------------------------------------------------------------------------
function gce() {
  if [[ "amgen" = $1 ]]; then
    git config --local user.name gahoward
    git config --local user.email gahoward@amgen.com
  elif [[ "edx" = $1 ]]; then
    git config --local user.name gary.howard
    git config --local user.email gary.howard@endotronicx.com
  elif [[ "fk" = $1 ]]; then
    git config --local user.name gahoward
    git config --local user.email gary.howard@fresenius-kabi.com
  elif [[ "mhp" = $1 ]]; then
    git config --local user.name ghoward
    git config --local user.email gahoward@mhealthpharma.com
  elif [[ "traap" = $1 ]]; then
    git config --local user.name Traap
    git config --local user.email gary.a.howard@mac.com
  else
    echo "Usage: gce [amgen|edx|fk|mhp|traap]"
    echo "Found: " $1
  fi
  git config --local --get user.name
  git config --local --get user.email
}

function resetBranch() {
  git reset --hard $1
  if [[ $? -eq 0 ]]; then
    git push --force
  fi
}

# ------------------------------------------------------------------------------
# Prompt
# ------------------------------------------------------------------------------
# see https://github.com/magicmonty/bash-git-prompt
PS1_START='\[\033[01;32m\]\u\[\033[01;33m\]@\[\033[01;35m\]\h\[\033[01;32m\]:\[\033[01;36m\]\w'
PS1_END='\n\[\033[01;36m\]\$\[\033[00m\] '
export PS1=${PS1_START}${PS1_END}

function prompt() {
  GIT_PROMPT_ONLY_IN_REPO=1
  GIT_PROMPT_START=${PS1_START}
  GIT_PROMPT_END=${PS1_END}
}

if [[ ${OSTYPE} =~ "darwin" ]]; then
  if [[ -f $(brew --prefix)/opt/bash-git-prompt/share/gitprompt.sh ]]; then
    prompt
    source "$(brew --prefix)/opt/bash-git-prompt/share/gitprompt.sh"
  fi
elif [[ ${OSTYPE} =~ "linux" ]] || [[ ${OSTYPE} =~ "cygwin" ]]; then
  if [[ -f ~/.bash-git-prompt/gitprompt.sh ]]; then
    prompt
    source ~/.bash-git-prompt/gitprompt.sh
  fi
fi

# ------------------------------------------------------------------------------
# Disable features / programs running on OSX.
# ------------------------------------------------------------------------------
function msa() { Launchctl remove com.microsoft.SyncServicesAgent ; }
function pah() { defaults write -g ApplePressAndHoldEnable -bool false ; }

# ------------------------------------------------------------------------------
# Set terminal title.
# ------------------------------------------------------------------------------
function title() { echo -n -e "\033]0;$1\007"; }

# ------------------------------------------------------------------------------
# Docker machine and stack commands
# ------------------------------------------------------------------------------
function sdm() {
  docker-machine env
  eval "$(docker-machine env default)"
  docker-machine start
}
function docker-gc() {
  docker ps --no-trunc -aq | xargs docker rm
  docker images -f "dangling=true" -q | xargs docker rmi
}
function dba() { stack exec -- doc-build; }
function dbc() { stack exec -- doc-build clean ; }
function dbh() { stack build hmst-documentation ; }
function dbt() { stack exec -- doc-build tex ; }
function dbti(){ stack exec -- env DONT_RERUN_TEX_BUILD=1 doc-build tex;}
function dbv() { stack build verify && stack exec verify ; }

# ------------------------------------------------------------------------------
# Generating a new SSH key and adding it to the ssh-agent
# https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent
# ------------------------------------------------------------------------------
function sshkeys (){
  eval "$(ssh-agent -s)"
  ssh-add ~/.ssh/traap_rsa
  ssh-add ~/.ssh/fkbb_rsa
}

function sshlist() {
  ps | awk '/ssh-agent/'
}

function sshkill() {
  for pid in $(ps -ef | awk '/ssh-agent/ {print $2}'); do kill -9 $pid; done
}

# ------------------------------------------------------------------------------
# Brew wants needs me to own usr/local
# ------------------------------------------------------------------------------
alias ulo='sudo chown -R $(whoami) /usr/local'

# ------------------------------------------------------------------------------
# Base16 Shell
# ------------------------------------------------------------------------------
BASE16_SHELL=$HOME/git/color/base16-shell/
[[ -n $PS1 ]] && [[ -s $BASE16_SHELL/profile_helper.sh ]] && eval "$($BASE16_SHELL/profile_helper.sh)"

# ------------------------------------------------------------------------------
# Repeat a command until a key is pressed.  The read command waits
# 1sec before timing out.
# ------------------------------------------------------------------------------
function repeat() {
  let passNo=0;
  while [ true ]; do
    read -t 1 -n 1
    if [ $? -gt 0 ]; then
      let passNo=$((passNo+1))
      clear
      echo Repeating [$@]  Ctrl-C to stop.  Pass: $passNo
      $@
      sleep 5
    fi
  done
}
alias rgl='repeat git logg -6'
alias rgs='repeat git status --short'

# ------------------------------------------------------------------------------
# JAVA.
# ------------------------------------------------------------------------------
CLASSPATH=build/classes/main:build/classes/test
export CLASSPATH

# ------------------------------------------------------------------------------
# Check the porcelain state of my git repositories.
# ------------------------------------------------------------------------------
function lsd() { ls -d * | tr -d '/' ; }
function gits(){
  dir=$(pwd)
  cd ${HOME}/git > /dev/null;
  for i in $(lsd); do
    d=${HOME}/git/${i%%}
    if [[ -d "${d}/.git" ]]; then
      echo "*** ${d} ***";
      cd ${d} > /dev/null
      if [[ -n $(git status --porcelain) ]]; then
        git status --short;
        echo;
        cd - > /dev/null;
      else
        if [[ "pull" == $1 ]]; then
          git pull
          echo;
          cd - > /dev/null;
        fi
      fi
    fi
  done;
  cd $dir
}

# ------------------------------------------------------------------------------
# Cxx helper function to simplify CxxTest use for C++ software.
# ------------------------------------------------------------------------------
function cxx() {
  ${HOME}/git/cxxtest/bin/cxxtestgen --error-printer -o Test$1.cpp Test$1.h
  g++ -w -o Test$1 Test$1.cpp
  ./Test$1
  rm Test$1.cpp
}

# ------------------------------------------------------------------------------
# Start Vim with clientserver when it is compiled in.
# ------------------------------------------------------------------------------
function vimCheck() {
  if [[ -n $(vim --version | grep servername) ]]; then
    alias vim='vim --servername VIM'
  fi
}

function vimu() {
  vim -u NORC $@
}
if [[ ${OSTYPE} =~ "darwin" ]]; then
  vimCheck
fi

# ------------------------------------------------------------------------------
# Perforce defaults.
# ------------------------------------------------------------------------------
if [[ ${OSTYPE} =~ "linux" ]]; then
  if [[ ${HOSTNAME} =~ "Ryder" ]]; then
    export P4DISK=/Volumes/Larry
    export P4HOST=localhost
    export P4PORT=1666
    export P4ROOT=${P4DISK}/p4root
    export P4CLIENT=Gary:on:Ryder
    alias p4='${P4DISK}/2013.1/p4'
    alias p4d='${P4DISK}/2013.1/p4d'
  fi
fi

# ------------------------------------------------------------------------------
# Read Unix man pages faster.
# ------------------------------------------------------------------------------
if [[ -f ${HOME}/.vim/bundle/vim-superman/bin/vman ]]; then
  export PATH="$PATH:$HOME/.vim/bundle/vim-superman/bin"
fi

# ------------------------------------------------------------------------------
# sdkman
# ------------------------------------------------------------------------------
if [[ -f ${HOME}/.sdkman/bin/sdkman-init.sh ]]; then
  export SDKMAN_DIR="${HOME}/.sdkman"
  source "${HOME}/.sdkman/bin/sdkman-init.sh"
fi

# ------------------------------------------------------------------------------
# Build gem 
# ------------------------------------------------------------------------------
function bldgem() {
  clear && cd $1 \
     && bundle install \
     && bundle exec rake \
     && bundle exec rake install \
     && amber --version
}

# ------------------------------------------------------------------------------
# Build something I know about. 
# ------------------------------------------------------------------------------
function bld() {
  case $1 in 
    amber)
      bldgem ${HOME}/git/amber
      ;;
    emend)
      bldgem ${HOME}/git/emend
      ;;
    daryn)
      bldgem ${HOME}/git/daryn
      ;;
    *)
      echo "bld: $1 not supported."
      echo "Usage: bld {amber|emend|daryn}"
  esac
}

# ------------------------------------------------------------------------------
# a docbld functions
# ------------------------------------------------------------------------------
DOCBLDPATH=${HOME}/git/docbld
export DOCBLDPATH

function docbld() {
  rake --rakefile ${DOCBLDPATH}/Rakefile $1
}
function newdoc() {
  ${DOCBLDPATH}/bin/newdoc $1 $2 $3
}

# ------------------------------------------------------------------------------
# emend function.
# ------------------------------------------------------------------------------
EMENDPATH=${HOME}/git/emend
export EMENDPATH

function newcomponent() {
  ${EMENDPATH}/bin/newcomponent $@
}

# ------------------------------------------------------------------------------
# amber function.
# ------------------------------------------------------------------------------
AMBERPATH=${HOME}/git/amber
export AMBERPATH

function newfactoryitem() {
  ${AMBERPATH}/bin/newfactoryitem $@
}

function check-test-output() {
  echo grep -rw --include=\s*.* test-output/ -e $1
  grep -rw --include=\s*.* test-output/ -e $1
}

function pass() {
  check-test-output PASS
}

function fail() {
  check-test-output FAIL
}

function validate-git-client() {
  cd ${HOME}/git/tool-validation/git-client
  rm -rf _build/ test-ouput/
  amber --nodryrun --environment --verbose --plan=command-line
  docbld
}

function validate-git-gui() {
  cd ${HOME}/git/tool-validation/git-client
  rm -rf _build/ test-ouput/
  amber --nodryrun --environment --verbose --plan=command-line \
        --language=en --browser=Chrome
  docbld
}

# ------------------------------------------------------------------------------
# spath function. 
# ------------------------------------------------------------------------------
function spath() {
  echo $PATH | sed -n 1'p' | tr ':' '\n' | while read word; do
    echo $word
  done
}

# ------------------------------------------------------------------------------
# Set my default editor.
# ------------------------------------------------------------------------------
export EDITOR=vim
